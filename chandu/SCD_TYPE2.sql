1.{MERGE INTO dataengineering.plan_ps.Dim_Supply_Plan_Matchset_Valid_Combinations AS Target USING (  SELECT concat(target.Assembly_Variant_Name, target.Connected_Product_Key_Material_Number, target.Location_ID, target.Region_Flag, target.Product_ID, target.Stock_Keeping_Unit_ID) as mergeKey,source.Source_System_Identifier,source.Logical_Deletion_Indicator,source.Source_System_Update_Timestamp,source.Insert_Gmt_Timestamp,source.Load_Job_Number,source.Source_System_Extract_Gmt_Timestamp,source.Update_Gmt_Timestamp,source.av AS Assembly_Variant_Name,source.bom_qty AS Bill_Of_Material_Quanity,source.evcpkmat AS Connected_Product_Key_Material_Number,source.ftype_sa AS Feature_Type_Sub_Assembly_Code,source.fvalue_sa AS Feature_Value_Sub_Assembly_Name,source.hub AS Hub_Description,source.load_date AS Load_Date,source.locid AS Location_ID,source.nart_flag AS Region_Flag,source.prdid AS Product_ID,source.sku AS Stock_Keeping_Unit_ID,source.sku_disco_date AS Stock_Keeping_Unit_Disco_Date,source.sku_disco_week AS Stock_Keeping_Unit_Disco_Week,source.sku_intro_date AS Stock_Keeping_Unit_Introduction_Date,source.sku_intro_week AS Stock_Keeping_Unit_Introduction_Week,source.actsafv_sa AS Actual_Sub_Assembly_Feature_Value_Name,source.Source_File_Name FROM dataengineering.plan_ps.tbl_sp_md_bw_valid_comb_z3 AS source    LEFT JOIN dataengineering.plan_ps.Dim_Supply_Plan_Matchset_Valid_Combinations AS target ON source.av = target.Assembly_Variant_Name AND source.evcpkmat = target.Connected_Product_Key_Material_Number AND source.locid = target.Location_ID AND source.nart_flag = target.Region_Flag AND source.prdid = target.Product_ID AND source.sku = target.Stock_Keeping_Unit_ID AND target.Is_Active_Flag in ('Y', 'D') UNION SELECT NULL AS mergeKey,source.Source_System_Identifier,source.Logical_Deletion_Indicator,source.Source_System_Update_Timestamp,source.Insert_Gmt_Timestamp,source.Load_Job_Number,source.Source_System_Extract_Gmt_Timestamp,source.Update_Gmt_Timestamp,source.av AS Assembly_Variant_Name,source.bom_qty AS Bill_Of_Material_Quanity,source.evcpkmat AS Connected_Product_Key_Material_Number,source.ftype_sa AS Feature_Type_Sub_Assembly_Code,source.fvalue_sa AS Feature_Value_Sub_Assembly_Name,source.hub AS Hub_Description,source.load_date AS Load_Date,source.locid AS Location_ID,source.nart_flag AS Region_Flag,source.prdid AS Product_ID,source.sku AS Stock_Keeping_Unit_ID,source.sku_disco_date AS Stock_Keeping_Unit_Disco_Date,source.sku_disco_week AS Stock_Keeping_Unit_Disco_Week,source.sku_intro_date AS Stock_Keeping_Unit_Introduction_Date,source.sku_intro_week AS Stock_Keeping_Unit_Introduction_Week,source.actsafv_sa AS Actual_Sub_Assembly_Feature_Value_Name,source.Source_File_Name FROM dataengineering.plan_ps.tbl_sp_md_bw_valid_comb_z3 AS source   LEFT JOIN dataengineering.plan_ps.Dim_Supply_Plan_Matchset_Valid_Combinations AS target     ON source.av = target.Assembly_Variant_Name AND source.evcpkmat = target.Connected_Product_Key_Material_Number AND source.locid = target.Location_ID AND source.nart_flag = target.Region_Flag AND source.prdid = target.Product_ID AND source.sku = target.Stock_Keeping_Unit_ID AND target.Is_Active_Flag in ('Y', 'D') WHERE (source.bom_qty <> target.Bill_Of_Material_Quanity OR source.ftype_sa <> target.Feature_Type_Sub_Assembly_Code OR source.fvalue_sa <> target.Feature_Value_Sub_Assembly_Name OR source.hub <> target.Hub_Description OR source.actsafv_sa <> target.Actual_Sub_Assembly_Feature_Value_Name   AND target.Is_Active_Flag = 'Y') OR target.Is_Active_Flag = 'D') AS source ON CONCAT(target.Assembly_Variant_Name, target.Connected_Product_Key_Material_Number, target.Location_ID, target.Region_Flag, target.Product_ID, target.Stock_Keeping_Unit_ID) = Source.mergeKey AND target.Is_Active_Flag in ('Y', 'D') WHEN MATCHED AND (   source.Bill_Of_Material_Quanity <> target.Bill_Of_Material_Quanity   OR source.Feature_Type_Sub_Assembly_Code <> target.Feature_Type_Sub_Assembly_Code   OR source.Feature_Value_Sub_Assembly_Name <> target.Feature_Value_Sub_Assembly_Name   OR source.Hub_Description <> target.Hub_Description   OR source.Actual_Sub_Assembly_Feature_Value_Name <> target.Actual_Sub_Assembly_Feature_Value_Name ) AND Target.Is_Active_Flag = 'Y' THEN   UPDATE SET Target.Effective_End_Date = Source.Insert_Gmt_Timestamp,Target.Update_Gmt_Timestamp = GETDATE(),Target.Is_Active_Flag = 'N',Target.Action_Name = 'UPDATE',Target.Logical_Deletion_Indicator = 'U' WHEN MATCHED AND (source.Bill_Of_Material_Quanity = target.Bill_Of_Material_Quanity   OR source.Feature_Type_Sub_Assembly_Code = target.Feature_Type_Sub_Assembly_Code   OR source.Feature_Value_Sub_Assembly_Name = target.Feature_Value_Sub_Assembly_Name   OR source.Hub_Description = target.Hub_Description   OR source.Actual_Sub_Assembly_Feature_Value_Name = target.Actual_Sub_Assembly_Feature_Value_Name ) AND Target.Is_Active_Flag = 'Y' THEN   UPDATE SET Target.Logical_Deletion_Indicator = 'U',Target.Update_Gmt_Timestamp = GETDATE(),Target.Insert_Gmt_Timestamp = Source.Insert_Gmt_Timestamp,Target.Bill_Of_Material_Quanity = source.Bill_Of_Material_Quanity,Target.Feature_Type_Sub_Assembly_Code = source.Feature_Type_Sub_Assembly_Code,Target.Feature_Value_Sub_Assembly_Name = source.Feature_Value_Sub_Assembly_Name,Target.Hub_Description = source.Hub_Description,Target.Actual_Sub_Assembly_Feature_Value_Name = source.Actual_Sub_Assembly_Feature_Value_Name,Target.Action_Name = 'UPDATE',Target.Source_File_Name = Source.Source_File_Name WHEN MATCHED AND Target.Is_Active_Flag = 'D' THEN   UPDATE SET Target.Update_Gmt_Timestamp = GETDATE(),Target.Is_Active_Flag = 'N' WHEN NOT MATCHED BY TARGET THEN  INSERT (Source_System_Identifier,Logical_Deletion_Indicator,Source_System_Update_Timestamp,     Insert_Gmt_Timestamp,Load_Job_Number,Source_System_Extract_Gmt_Timestamp,Update_Gmt_Timestamp,Assembly_Variant_Name,     Bill_Of_Material_Quanity,Connected_Product_Key_Material_Number,Feature_Type_Sub_Assembly_Code,Feature_Value_Sub_Assembly_Name,Hub_Description,Load_Date,Location_ID,Region_Flag,Product_ID,Stock_Keeping_Unit_ID,Stock_Keeping_Unit_Disco_Date,     Stock_Keeping_Unit_Disco_Week,Stock_Keeping_Unit_Introduction_Date,Stock_Keeping_Unit_Introduction_Week,     Actual_Sub_Assembly_Feature_Value_Name,Effective_Start_Date,Effective_End_Date,Is_Active_Flag,Action_Name,Source_File_Name) VALUES (Source.Source_System_Identifier,'I',Source.Source_System_Update_Timestamp,GETDATE(),Source.Load_Job_Number,Source.Source_System_Extract_Gmt_Timestamp,GETDATE(),Source.Assembly_Variant_Name,Source.Bill_Of_Material_Quanity,Source.Connected_Product_Key_Material_Number,Source.Feature_Type_Sub_Assembly_Code,Source.Feature_Value_Sub_Assembly_Name,Source.Hub_Description,Source.Load_Date,Source.Location_ID,Source.Region_Flag,Source.Product_ID,Source.Stock_Keeping_Unit_ID,Source.Stock_Keeping_Unit_Disco_Date,Source.Stock_Keeping_Unit_Disco_Week,Source.Stock_Keeping_Unit_Introduction_Date,Source.Stock_Keeping_Unit_Introduction_Week,Source.Actual_Sub_Assembly_Feature_Value_Name,current_date(),'9999-12-31 23:59:59','Y','INSERT',Source.Source_File_Name) WHEN NOT MATCHED BY SOURCE AND Target.Is_Active_Flag = 'Y' THEN   UPDATE SET Target.Effective_End_Date = GETDATE(),Target.Update_Gmt_Timestamp = GETDATE(),Target.Is_Active_Flag = 'D',Target.Action_Name = 'DELETE',Target.Logical_Deletion_Indicator = 'D'}
